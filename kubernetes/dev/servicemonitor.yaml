# ServiceMonitor for RAG API Metrics
#
# ARCHITECTURE NOTE:
# This file lives in kubernetes/dev/ (not terraform/) because:
# 1. ServiceMonitor is APPLICATION-SPECIFIC (tells Prometheus about rag-api)
# 2. Monitoring infrastructure (Prometheus/Grafana) is in terraform/modules/monitoring/
# 3. This follows the hybrid approach: Terraform for infra, kubectl for app configs
#
# DEPLOYMENT:
# kubectl apply -f kubernetes/dev/servicemonitor.yaml
#
# WHAT IT DOES:
# - Creates a Service to expose metrics port
# - Creates a ServiceMonitor that tells Prometheus to scrape /metrics every 15s
# - Prometheus Operator watches for ServiceMonitor resources and auto-configures scraping
---
apiVersion: v1
kind: Service
metadata:
  name: rag-api-metrics
  namespace: dev
  labels:
    app: rag-api
spec:
  selector:
    app: rag-api
  ports:
    - name: metrics
      port: 8000
      targetPort: 8000
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: rag-api
  namespace: dev
  labels:
    app: rag-api
spec:
  selector:
    matchLabels:
      app: rag-api
  endpoints:
    - port: metrics
      path: /metrics
      interval: 15s

