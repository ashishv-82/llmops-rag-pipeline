# CD Workflow: Automated Deployment to Dev Environment
# Triggers on every push to main (after PR merge)
# Deploys latest Docker image to dev namespace in Kubernetes

name: CD - Deploy to Dev

on:
  workflow_call:
    inputs:
      ecr_registry:
        required: true
        type: string
        description: "ECR Registry URL"
      build_number:
        required: true
        type: string
        description: "Build number to deploy"

jobs:
  # Job: Deploy to Development Environment
  deploy-dev:
    name: Deploy to Dev Environment
    runs-on: ubuntu-latest
    environment: development  # GitHub Environment for approval/secrets
    steps:
      - uses: actions/checkout@v4
      
      # Authenticate with AWS for EKS access
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2
      
      # Configure kubectl to connect to EKS cluster
      - name: Update kubeconfig (Simulated)
        run: |
          echo "Simulating: aws eks update-kubeconfig --name llmops-rag-cluster"
          # aws eks update-kubeconfig \
          #   --name llmops-rag-cluster \
          #   --region ap-southeast-2
      
      # Login to ECR to pull the latest image
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Update Deployment Image (Simulated)
        env:
          ECR_REGISTRY: ${{ inputs.ecr_registry }}
          BUILD_NUMBER: ${{ inputs.build_number }}
        run: |
          echo "Simulating: kubectl set image deployment/rag-api api=$ECR_REGISTRY/llmops-rag-api:build-$BUILD_NUMBER -n dev"
          # kubectl set image deployment/rag-api \
          #   api=$ECR_REGISTRY/llmops-rag-api:build-$BUILD_NUMBER \
          #   -n dev
      
      # Wait for Kubernetes to complete the rolling update
      - name: Wait for Rollout (Simulated)
        run: |
          echo "Simulating: kubectl rollout status deployment/rag-api -n dev --timeout=5m"
          # kubectl rollout status deployment/rag-api -n dev --timeout=5m
      
      # Verify deployment with basic smoke tests
      - name: Run Smoke Tests (Simulated)
        run: |
          echo "Simulating: Smoke Tests"
          # API_URL=$(kubectl get svc rag-api-service -n dev -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          # curl -f http://$API_URL/health || exit 1
          # curl -f -X POST http://$API_URL/query \
          #   -H "Content-Type: application/json" \
          #   -d '{"question": "test", "domain": "general"}' || exit 1
      
      # Send success notification to Slack (optional)
      - name: Notify Slack on Success
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âœ… Deployed to Dev: ${{ github.sha }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}