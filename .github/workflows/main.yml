# Main Orchestration Workflow
name: Main Pipeline

on:
  push:
    branches: [main]
    paths:
      - 'api/**'
      - 'kubernetes/**'
      - 'tests/**'
      - '.github/workflows/**'
      - '!data/**'  # Explicitly ignore data changes (handled by data-sync.yml)

jobs:
  # 1. CI Workflow (Lint, Test, Build)
  build:
    name: Build
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  # 2. CD Workflow (Deploy to Dev)
  deploy-dev:
    name: Deploy to Dev
    needs: build
    if: success()
    uses: ./.github/workflows/cd-dev.yml
    with:
      ecr_registry: ${{ needs.build.outputs.registry }}
      build_number: ${{ github.run_number }}
    secrets: inherit
