# CD Workflow: Gated Deployment to Production
# Requires manual approval via GitHub Environment protection
# Supports multiple deployment strategies for zero-downtime releases

name: CD - Deploy to Production

on:
  workflow_dispatch:  # Manual trigger with approval required
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: true  # Must specify exact version (no defaults)
      deployment_strategy:
        description: 'Deployment strategy'
        required: true
        type: choice
        options:
          - rolling      # Standard rolling update
          - blue-green   # Zero-downtime switch
          - canary       # Gradual rollout

jobs:
  # Job: Deploy to Production with Approval Gate
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment:  # Requires manual approval before deployment
      name: production
      url: https://rag.example.com  # Production URL for verification
    steps:
      - uses: actions/checkout@v4
      
      # Authenticate with AWS for EKS access
      - name: Configure AWS & kubectl
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2
      
      # Configure kubectl to connect to production EKS cluster
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name llmops-rag-cluster \
            --region ap-southeast-2
      
      # ----------------------------------------------------------------
      # 1. Build & Push API
      # ----------------------------------------------------------------
      - name: Build & Push API
        run: |
          # Use image_tag input or git sha
          TAG=${{ github.event.inputs.image_tag }}
          ./scripts/build_api.sh $TAG

      # ----------------------------------------------------------------
      # 2. Build & Push Frontend
      # ----------------------------------------------------------------
      - name: Build & Push Frontend
        run: |
          # Frontend currently uses latest in build script, but we can override if verified
          # for now we stick to latest for simplicity or update script to accept tag
          ./scripts/build_frontend.sh

      # ----------------------------------------------------------------
      # 3. Deploy Infrastructure & App
      # ----------------------------------------------------------------
      - name: Deploy to EKS (Manifests)
        run: |
          # This script applies all Services, Deployments, Ingress, etc.
          # It ensures the 'Shape' of the cluster matches the code.
          ./scripts/deploy_to_eks.sh prod

      # ----------------------------------------------------------------
      # 4. Update Image Versions (Rolling Update)
      # ----------------------------------------------------------------
      - name: Set Specific Image Version
        if: github.event.inputs.deployment_strategy == 'rolling'
        run: |
          TAG=${{ github.event.inputs.image_tag }}
          
          # Update API Deployment
          kubectl set image deployment/rag-api \
            rag-api=${{ secrets.ECR_REGISTRY }}/llmops-rag-api:$TAG \
            -n prod
            
          # Update Frontend Deployment (if we versioned it, otherwise it stays latest)
          # kubectl set image deployment/rag-frontend ...
          
          # Wait for rollout
          kubectl rollout status deployment/rag-api -n prod --timeout=10m
          kubectl rollout status deployment/rag-frontend -n prod --timeout=5m

      # ----------------------------------------------------------------
      # 5. Verify Health
      # ----------------------------------------------------------------
      - name: Health Check
        run: |
          # Retreive LoadBalancer URL dynamically if PROD_API_URL not set
          API_URL=${{ secrets.PROD_API_URL }}
          
          echo "Checking Health at $API_URL..."
          for i in {1..5}; do
            if curl -f "$API_URL/health"; then
              echo "✅ Health check passed"
              exit 0
            fi
            sleep 10
          done
          echo "❌ Health check failed"
          exit 1