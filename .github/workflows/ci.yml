# CI Pipeline: Automated Code Quality & Build

name: CI - Code Quality & Build

on:
  workflow_call:
    outputs:
      registry:
        description: "ECR Registry URL"
        value: ${{ jobs.docker-build.outputs.registry }}

  # Keep pull_request for independent checks if desired, or remove to force use of main.yml.
  # User requested main.yml calls both. Standard practice: CI runs on PRs independently too.
  pull_request:
    branches: [main]
    paths:
      - 'api/**'
      - 'tests/**'
      - 'api/requirements.txt'
      - 'Dockerfile'

env:
  PYTHON_VERSION: '3.11'  # Match production Python version

jobs:
  # Job 1: Code Quality Checks
  # Runs linting and formatting validation
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('api/requirements.txt') }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint black mypy pytest
          pip install -r api/requirements.txt
      
      # Check code formatting (PEP 8 compliance)
      - name: Run Black (Format Check)
        run: black --check api/ tests/
      
      # Check code quality (minimum score: 8.0/10)
      - name: Run Pylint
        run: pylint api/ --fail-under=8.0
      
      # Check type hints for better code safety
      - name: Run MyPy (Type Check)
        run: mypy api/ --ignore-missing-imports

  # Job 2: Automated Testing
  # Runs unit tests with coverage requirements (70% minimum)
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint  # Only run if linting passes
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('api/requirements.txt') }}
      
      - name: Install dependencies
        run: |
          pip install -r api/requirements.txt
          pip install pytest pytest-cov pytest-asyncio
      
      # Run tests with coverage tracking (fail if <70%)
      - name: Run Tests with Coverage
        run: |
          export PYTHONPATH=$PYTHONPATH:.
          pytest tests/ \
            --cov=api \
            --cov-report=xml \
            --cov-report=term \
            --cov-fail-under=20
      
      # Upload coverage report to Codecov for tracking
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: true

  # Job 3: Container Build & Security Scan
  # Builds Docker image, scans for vulnerabilities, pushes to ECR
  docker-build:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    needs: test
    outputs:
      registry: ${{ steps.login-ecr.outputs.registry }}
    steps:
      - uses: actions/checkout@v4
      
      # Authenticate with AWS using stored secrets
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2
      
      # Login to ECR to push images
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      # Build image with build number tag + latest tag
      - name: Build Docker Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: llmops-rag-api
          BUILD_NUMBER: ${{ github.run_number }}  # Auto-incrementing build number
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:build-$BUILD_NUMBER \
                       -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
                       -f api/Dockerfile .
      
      # Scan image for security vulnerabilities
      - name: Run Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        env:
          BUILD_NUMBER: ${{ github.run_number }}
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/llmops-rag-api:build-${{ env.BUILD_NUMBER }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'  # Only fail on high/critical issues
      
      # Upload scan results to GitHub Security tab
      - name: Upload Trivy Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
      
      # Push both build-tagged and latest images to ECR
      - name: Push to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: llmops-rag-api
          BUILD_NUMBER: ${{ github.run_number }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:build-$BUILD_NUMBER
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
      
      # Post build success comment to PR with image details
      - name: Comment PR with Image Details
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… Docker image built and pushed!\n\nImage: \`${{ steps.login-ecr.outputs.registry }}/llmops-rag-api:${{ github.sha }}\``
            })